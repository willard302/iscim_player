import{e as G,af as N,P as le,p as _e,r as D,f as K,J as Z,v as Re,S as ne,b as r,l as ie,z as ae,D as X,a5 as fe,n as oe,y as ge,ag as Oe,W as ze,a9 as M,a8 as O,m as V,a4 as re,ah as he,G as Ue,ai as se,aj as H,a7 as De,ak as Te,T as W,al as we,am as Fe,an as Ae,ac as be,ao as Be,ap as ee,aq as Le,ar as Xe,E as pe,as as ye,at as Ye,V as Me,C as Ie,au as Ve,s as Ze,N as ce,O as ue,av as Ee,I as $e,L as je,i as Ne,o as He,w as We,k as Ge,g as qe,_ as Je}from"./CxRIJn2k.js";/* empty css        */import"./Be22cbFi.js";import{F as Ke}from"./Cof-mslr.js";import{I as Ce}from"./1MultWaQ.js";/* empty css        *//* empty css        */import{u as Qe}from"./D28Hbfvk.js";import{S as ea,a as aa}from"./DNgW3PBO.js";const de=e=>Math.sqrt((e[0].clientX-e[1].clientX)**2+(e[0].clientY-e[1].clientY)**2),ta=e=>({x:(e[0].clientX+e[1].clientX)/2,y:(e[0].clientY+e[1].clientY)/2}),te=ie("image-preview")[1],ve=2.6,oa={src:String,show:Boolean,active:Number,minZoom:N(oe),maxZoom:N(oe),rootWidth:N(Number),rootHeight:N(Number),disableZoom:Boolean,doubleScale:Boolean,closeOnClickImage:Boolean,closeOnClickOverlay:Boolean,vertical:Boolean};var la=G({props:oa,emits:["scale","close","longPress"],setup(e,{emit:l,slots:c}){const a=le({scale:1,moveX:0,moveY:0,moving:!1,zooming:!1,initializing:!1,imageRatio:0}),u=_e(),n=D(),p=D(),w=D(!1),g=D(!1);let y=0;const i=K(()=>{const{scale:t,moveX:s,moveY:v,moving:S,zooming:R,initializing:B}=a,J={transitionDuration:R||S||B?"0s":".3s"};return(t!==1||g.value)&&(J.transform=`matrix(${t}, 0, 0, ${t}, ${s}, ${v})`),J}),m=K(()=>{if(a.imageRatio){const{rootWidth:t,rootHeight:s}=e,v=w.value?s/a.imageRatio:t;return Math.max(0,(a.scale*v-t)/2)}return 0}),h=K(()=>{if(a.imageRatio){const{rootWidth:t,rootHeight:s}=e,v=w.value?s:t*a.imageRatio;return Math.max(0,(a.scale*v-s)/2)}return 0}),b=(t,s)=>{var v;if(t=X(t,+e.minZoom,+e.maxZoom+1),t!==a.scale){const S=t/a.scale;if(a.scale=t,s){const R=ge((v=n.value)==null?void 0:v.$el),B={x:R.width*.5,y:R.height*.5},J=a.moveX-(s.x-R.left-B.x)*(S-1),ke=a.moveY-(s.y-R.top-B.y)*(S-1);a.moveX=X(J,-m.value,m.value),a.moveY=X(ke,-h.value,h.value)}else a.moveX=0,a.moveY=g.value?y:0;l("scale",{scale:t,index:e.active})}},x=()=>{b(1)},E=()=>{const t=a.scale>1?1:2;b(t,t===2||g.value?{x:u.startX.value,y:u.startY.value}:void 0)};let T,F,A,f,_,k,L,$,o=!1;const d=t=>{const{touches:s}=t;if(T=s.length,T===2&&e.disableZoom)return;const{offsetX:v}=u;u.start(t),F=a.moveX,A=a.moveY,$=Date.now(),o=!1,a.moving=T===1&&(a.scale!==1||g.value),a.zooming=T===2&&!v.value,a.zooming&&(f=a.scale,_=de(s))},P=t=>{const{touches:s}=t;if(u.move(t),a.moving){const{deltaX:v,deltaY:S}=u,R=v.value+F,B=S.value+A;if((e.vertical?u.isVertical()&&Math.abs(B)>h.value:u.isHorizontal()&&Math.abs(R)>m.value)&&!o){a.moving=!1;return}o=!0,ae(t,!0),a.moveX=X(R,-m.value,m.value),a.moveY=X(B,-h.value,h.value)}if(a.zooming&&(ae(t,!0),s.length===2)){const v=de(s),S=f*v/_;k=ta(s),b(S,k)}},I=t=>{var s;const v=(s=p.value)==null?void 0:s.$el;if(!v)return;const S=v.firstElementChild,R=t.target===v,B=S?.contains(t.target);!e.closeOnClickImage&&B||!e.closeOnClickOverlay&&R||l("close")},z=t=>{if(T>1)return;const s=Date.now()-$,v=250;u.isTap.value&&(s<v?e.doubleScale?L?(clearTimeout(L),L=null,E()):L=setTimeout(()=>{I(t),L=null},v):I(t):s>Oe&&l("longPress"))},U=t=>{let s=!1;if((a.moving||a.zooming)&&(s=!0,a.moving&&F===a.moveX&&A===a.moveY&&(s=!1),!t.touches.length)){a.zooming&&(a.moveX=X(a.moveX,-m.value,m.value),a.moveY=X(a.moveY,-h.value,h.value),a.zooming=!1),a.moving=!1,F=0,A=0,f=1,a.scale<1&&x();const v=+e.maxZoom;a.scale>v&&b(v,k)}ae(t,s),z(t),u.reset()},q=()=>{const{rootWidth:t,rootHeight:s}=e,v=s/t,{imageRatio:S}=a;w.value=a.imageRatio>v&&S<ve,g.value=a.imageRatio>v&&S>=ve,g.value&&(y=(S*t-s)/2,a.moveY=y,a.initializing=!0,ze(()=>{a.initializing=!1})),x()},j=t=>{const{naturalWidth:s,naturalHeight:v}=t.target;a.imageRatio=v/s,q()};return Z(()=>e.active,x),Z(()=>e.show,t=>{t||x()}),Z(()=>[e.rootWidth,e.rootHeight],q),Re("touchmove",P,{target:K(()=>{var t;return(t=p.value)==null?void 0:t.$el})}),ne({resetScale:x}),()=>{const t={loading:()=>r(fe,{type:"spinner"},null)};return r(ea,{ref:p,class:te("swipe-item"),onTouchstartPassive:d,onTouchend:U,onTouchcancel:U},{default:()=>[c.image?r("div",{class:te("image-wrap")},[c.image({src:e.src,onLoad:j,style:i.value})]):r(Ce,{ref:n,src:e.src,fit:"contain",class:te("image",{vertical:w.value}),style:i.value,onLoad:j},t)]})}}});const[na,Y]=ie("image-preview"),ia=["show","teleport","transition","overlayStyle","closeOnPopstate"],sa={show:Boolean,loop:O,images:he(),minZoom:V(1/3),maxZoom:V(3),overlay:O,vertical:Boolean,closeable:Boolean,showIndex:O,className:re,closeIcon:M("clear"),transition:String,beforeClose:Function,doubleScale:O,overlayClass:re,overlayStyle:Object,swipeDuration:V(300),startPosition:V(0),showIndicators:Boolean,closeOnPopstate:O,closeOnClickImage:O,closeOnClickOverlay:O,closeIconPosition:M("top-right"),teleport:[String,Object]};var Pe=G({name:na,props:sa,emits:["scale","close","closed","change","longPress","update:show"],setup(e,{emit:l,slots:c}){const a=D(),u=D(),n=le({active:0,rootWidth:0,rootHeight:0,disableZoom:!1}),p=()=>{if(a.value){const f=ge(a.value.$el);n.rootWidth=f.width,n.rootHeight=f.height,a.value.resize()}},w=f=>l("scale",f),g=f=>l("update:show",f),y=()=>{we(e.beforeClose,{args:[n.active],done:()=>g(!1)})},i=f=>{f!==n.active&&(n.active=f,l("change",f))},m=()=>{if(e.showIndex)return r("div",{class:Y("index")},[c.index?c.index({index:n.active}):`${n.active+1} / ${e.images.length}`])},h=()=>{if(c.cover)return r("div",{class:Y("cover")},[c.cover()])},b=()=>{n.disableZoom=!0},x=()=>{n.disableZoom=!1},E=()=>r(aa,{ref:a,lazyRender:!0,loop:e.loop,class:Y("swipe"),vertical:e.vertical,duration:e.swipeDuration,initialSwipe:e.startPosition,showIndicators:e.showIndicators,indicatorColor:"white",onChange:i,onDragEnd:x,onDragStart:b},{default:()=>[e.images.map((f,_)=>r(la,{ref:k=>{_===n.active&&(u.value=k)},src:f,show:e.show,active:n.active,maxZoom:e.maxZoom,minZoom:e.minZoom,rootWidth:n.rootWidth,rootHeight:n.rootHeight,disableZoom:n.disableZoom,doubleScale:e.doubleScale,closeOnClickImage:e.closeOnClickImage,closeOnClickOverlay:e.closeOnClickOverlay,vertical:e.vertical,onScale:w,onClose:y,onLongPress:()=>l("longPress",{index:_})},{image:c.image}))]}),T=()=>{if(e.closeable)return r(W,{role:"button",name:e.closeIcon,class:[Y("close-icon",e.closeIconPosition),Te],onClick:y},null)},F=()=>l("closed"),A=(f,_)=>{var k;return(k=a.value)==null?void 0:k.swipeTo(f,_)};return ne({resetScale:()=>{var f;(f=u.value)==null||f.resetScale()},swipeTo:A}),Ue(p),Z([Fe,Ae],p),Z(()=>e.startPosition,f=>i(+f)),Z(()=>e.show,f=>{const{images:_,startPosition:k}=e;f?(i(+k),be(()=>{p(),A(+k,{immediate:!0})})):l("close",{index:n.active,url:_[n.active]})}),()=>r(De,se({class:[Y(),e.className],overlayClass:[Y("overlay"),e.overlayClass],onClosed:F,"onUpdate:show":g},H(e,ia)),{default:()=>[T(),E(),m(),h()]})}});let Q;const ra={loop:!0,images:[],maxZoom:3,minZoom:1/3,onScale:void 0,onClose:void 0,onChange:void 0,vertical:!1,teleport:"body",className:"",showIndex:!0,closeable:!1,closeIcon:"clear",transition:void 0,beforeClose:void 0,doubleScale:!0,overlayStyle:void 0,overlayClass:void 0,startPosition:0,swipeDuration:300,showIndicators:!1,closeOnPopstate:!0,closeOnClickOverlay:!0,closeIconPosition:"top-right"};function ca(){({instance:Q}=Le({setup(){const{state:e,toggle:l}=Xe(),c=()=>{e.images=[]};return()=>r(Pe,se(e,{onClosed:c,"onUpdate:show":l}),null)}}))}const ua=(e,l=0)=>{if(Be)return Q||ca(),e=Array.isArray(e)?{images:e,startPosition:l}:e,Q.open(ee({},ra,e)),Q};pe(Pe);const[da,C,va]=ie("uploader");function me(e,l){return new Promise(c=>{if(l==="file"){c();return}const a=new FileReader;a.onload=u=>{c(u.target.result)},l==="dataUrl"?a.readAsDataURL(e):l==="text"&&a.readAsText(e)})}function Se(e,l){return ye(e).some(c=>c.file?Ye(l)?l(c.file):c.file.size>+l:!1)}function ma(e,l){const c=[],a=[];return e.forEach(u=>{Se(u,l)?a.push(u):c.push(u)}),{valid:c,invalid:a}}const fa=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg|avif)/i,ga=e=>fa.test(e);function xe(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?ga(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}var ha=G({props:{name:oe,item:N(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,reupload:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview","reupload"],setup(e,{emit:l,slots:c}){const a=()=>{const{status:i,message:m}=e.item;if(i==="uploading"||i==="failed"){const h=i==="failed"?r(W,{name:"close",class:C("mask-icon")},null):r(fe,{class:C("loading")},null),b=Me(m)&&m!=="";return r("div",{class:C("mask")},[h,b&&r("div",{class:C("mask-message")},[m])])}},u=i=>{const{name:m,item:h,index:b,beforeDelete:x}=e;i.stopPropagation(),we(x,{args:[h,{name:m,index:b}],done:()=>l("delete")})},n=()=>l("preview"),p=()=>l("reupload"),w=()=>{if(e.deletable&&e.item.status!=="uploading"){const i=c["preview-delete"];return r("div",{role:"button",class:C("preview-delete",{shadow:!i}),tabindex:0,"aria-label":va("delete"),onClick:u},[i?i():r(W,{name:"cross",class:C("preview-delete-icon")},null)])}},g=()=>{if(c["preview-cover"]){const{index:i,item:m}=e;return r("div",{class:C("preview-cover")},[c["preview-cover"](ee({index:i},m))])}},y=()=>{const{item:i,lazyLoad:m,imageFit:h,previewSize:b,reupload:x}=e;return xe(i)?r(Ce,{fit:h,src:i.objectUrl||i.content||i.url,class:C("preview-image"),width:Array.isArray(b)?b[0]:b,height:Array.isArray(b)?b[1]:b,lazyLoad:m,onClick:x?p:n},{default:g}):r("div",{class:C("file"),style:Ie(e.previewSize)},[r(W,{class:C("file-icon"),name:"description"},null),r("div",{class:[C("file-name"),"van-ellipsis"]},[i.file?i.file.name:i.url]),g()])};return()=>r("div",{class:C("preview")},[y(),a(),w()])}});const wa={name:V(""),accept:M("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:V(1/0),imageFit:M("cover"),resultType:M("dataUrl"),uploadIcon:M("photograph"),uploadText:String,deletable:O,reupload:Boolean,afterRead:Function,showUpload:O,modelValue:he(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:O,previewOptions:Object,previewFullImage:O,maxSize:{type:[Number,String,Function],default:1/0}};var ba=G({name:da,props:wa,emits:["delete","oversize","clickUpload","closePreview","clickPreview","clickReupload","update:modelValue"],setup(e,{emit:l,slots:c}){const a=D(),u=[],n=D(-1),p=D(!1),w=(o=e.modelValue.length)=>({name:e.name,index:o}),g=()=>{a.value&&(a.value.value="")},y=o=>{if(g(),Se(o,e.maxSize))if(Array.isArray(o)){const d=ma(o,e.maxSize);if(o=d.valid,l("oversize",d.invalid,w()),!o.length)return}else{l("oversize",o,w());return}if(o=le(o),n.value>-1){const d=[...e.modelValue];d.splice(n.value,1,o),l("update:modelValue",d),n.value=-1}else l("update:modelValue",[...e.modelValue,...ye(o)]);e.afterRead&&e.afterRead(o,w())},i=o=>{const{maxCount:d,modelValue:P,resultType:I}=e;if(Array.isArray(o)){const z=+d-P.length;o.length>z&&(o=o.slice(0,z)),Promise.all(o.map(U=>me(U,I))).then(U=>{const q=o.map((j,t)=>{const s={file:j,status:"",message:"",objectUrl:URL.createObjectURL(j)};return U[t]&&(s.content=U[t]),s});y(q)})}else me(o,I).then(z=>{const U={file:o,status:"",message:"",objectUrl:URL.createObjectURL(o)};z&&(U.content=z),y(U)})},m=o=>{const{files:d}=o.target;if(e.disabled||!d||!d.length)return;const P=d.length===1?d[0]:[].slice.call(d);if(e.beforeRead){const I=e.beforeRead(P,w());if(!I){g();return}if(Ee(I)){I.then(z=>{i(z||P)}).catch(g);return}}i(P)};let h;const b=()=>l("closePreview"),x=o=>{if(e.previewFullImage){const d=e.modelValue.filter(xe),P=d.map(I=>(I.objectUrl&&!I.url&&I.status!=="failed"&&(I.url=I.objectUrl,u.push(I.url)),I.url)).filter(Boolean);h=ua(ee({images:P,startPosition:d.indexOf(o),onClose:b},e.previewOptions))}},E=()=>{h&&h.close()},T=(o,d)=>{const P=e.modelValue.slice(0);P.splice(d,1),l("update:modelValue",P),l("delete",o,w(d))},F=o=>{p.value=!0,n.value=o,be(()=>$())},A=()=>{p.value||(n.value=-1),p.value=!1},f=(o,d)=>{const P=["imageFit","deletable","reupload","previewSize","beforeDelete"],I=ee(H(e,P),H(o,P,!0));return r(ha,se({item:o,index:d,onClick:()=>l(e.reupload?"clickReupload":"clickPreview",o,w(d)),onDelete:()=>T(o,d),onPreview:()=>x(o),onReupload:()=>F(d)},H(e,["name","lazyLoad"]),I),H(c,["preview-cover","preview-delete"]))},_=()=>{if(e.previewImage)return e.modelValue.map(f)},k=o=>l("clickUpload",o),L=()=>{const o=e.modelValue.length<+e.maxCount,d=e.readonly?null:r("input",{ref:a,type:"file",class:C("input"),accept:e.accept,capture:e.capture,multiple:e.multiple&&n.value===-1,disabled:e.disabled,onChange:m,onClick:A},null);return c.default?ce(r("div",{class:C("input-wrapper"),onClick:k},[c.default(),d]),[[ue,o]]):ce(r("div",{class:C("upload",{readonly:e.readonly}),style:Ie(e.previewSize),onClick:k},[r(W,{name:e.uploadIcon,class:C("upload-icon")},null),e.uploadText&&r("span",{class:C("upload-text")},[e.uploadText]),d]),[[ue,e.showUpload&&o]])},$=()=>{a.value&&!e.disabled&&a.value.click()};return Ve(()=>{u.forEach(o=>URL.revokeObjectURL(o))}),ne({chooseFile:$,reuploadFile:F,closeImagePreview:E}),Ze(()=>e.modelValue),()=>r("div",{class:C()},[r("div",{class:C("wrapper",{disabled:e.disabled})},[_(),L()])])}});const pa=pe(ba),ya=()=>{const e=$e();return{uploadFile:async(a,u)=>{if(!a)throw"No file selected";const n=Array.isArray(a)?a:[a];return(await Promise.all(n.map(async w=>{const g=w.file;if(!g)throw new Error("File is undefined");const y=`${Date.now()}-${g.name}`,{error:i}=await e.storage.from(u).upload(y,g,{cacheControl:"3600",upsert:!1});if(i)throw`Upload error: ${i.message}`;const{data:m}=e.storage.from(u).getPublicUrl(y);return m?.publicUrl??""}))).filter(w=>w!=="")},deleteFile:async(a,u)=>{const n=a.map(g=>decodeURIComponent(g.split("/").pop())),{data:p,error:w}=await e.storage.from(u).remove(n);if(w)throw`Delete error: ${w.message}`;console.log("Deleted files: ",p)}}},Ia=G({__name:"Avatar",setup(e){const{uploadFile:l,deleteFile:c}=ya(),{updateUser:a,getUser:u}=Qe(),n=je(),p=D([{url:n.userInfo.avatar_url}]),w=async g=>{if(!n.userInfo||!n.userInfo.id)throw"There is no user or userId.";const y=n.userInfo.id,i=await u(y);if(!i)return;const m=i.avatar_url,h=g;if(!h||!h.file)return;const b=await l(h,"icc_avatar");if(!b)throw"There is no url.";if(p.value=[{url:b[0]}],!await a(y,{avatar_url:b[0]}))throw"there is no data";if(n.userInfo&&Object.assign(n.userInfo,{avatar_url:b[0]}),!m)throw"There is no oldUrl.";await c([m],"icc_avatar")};return(g,y)=>{const i=pa,m=Ke;return He(),Ne(m,{name:"uploader"},{input:We(()=>[r(i,{modelValue:qe(p),"onUpdate:modelValue":y[0]||(y[0]=h=>Ge(p)?p.value=h:null),"after-read":w,"preview-size":"160px",deletable:!1,"show-upload":!1,reupload:""},null,8,["modelValue"])]),_:1})}}}),Ua=Object.assign(Je(Ia,[["__scopeId","data-v-1b461e6c"]]),{__name:"Avatar"});export{Ua as _};
